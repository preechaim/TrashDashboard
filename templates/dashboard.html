<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Trashbin">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-192.png') }}">
    <title>Smart Trashbin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üóëÔ∏è Smart Trashbin Dashboard</h1>
            <!-- <p class="subtitle">Real-time Waste Management System with Scope 3 Emissions Tracking</p> -->
        </header>

        <!-- Detect Trash Section -->
        <section class="detect-section">
            <h2 class="clickable-header" onclick="toggleSection('detect-content', 'detect-icon')">üì∑ Trash Detection <span id="detect-icon">‚ñº</span></h2>
            <div class="detect-content" id="detect-content" style="display: none;">
                <div class="video-container">
                    <div class="video-placeholder" id="cameraFeed">
                        <p>üìπ Camera Feed</p>
                        <p class="placeholder-text">Upload or send base64 image</p>
                    </div>
                    <img id="cameraImage" style="display: none; width: 100%; height: auto; border-radius: 10px;" />
                </div>
                <div class="detect-actions">
                    <button class="detect-action-btn" onclick="detectTrash()">üîç Detect</button>
                </div>
                <div id="detectionResult" class="detection-result" style="display: none;"></div>
            </div>
        </section>

        <!-- Scope 3 Emissions Overview -->
        <section class="emissions-overview">
            <h2 class="clickable-header" onclick="toggleEmissionsInfo()">üåç Scope 3 Carbon Footprint <span id="toggle-icon">‚ñº</span></h2>
            <div class="emissions-info" id="emissions-info" style="display: none;">
                <p><strong>Emissions Factors:</strong> Landfill: 0.5 kg CO‚ÇÇ/kg | Recycling Process: 0.1 kg CO‚ÇÇ/kg | Production Avoided: 2.0 kg CO‚ÇÇ/kg</p>
                {% if emissions %}
                <p class="last-updated"><span class="label">Last Calculated:</span> <span class="timestamp-cell">{{ emissions.last_updated }}</span></p>
                {% endif %}
            </div>
            <div class="emissions-grid">
                <div class="emission-card positive">
                    <div class="emission-icon">üå±</div>
                    <div class="emission-value">{{ "%.2f"|format(emissions.total_co2_avoided if emissions else 0) }} kg</div>
                    <div class="emission-label">CO‚ÇÇ Avoided (Recycling)</div>
                </div>
                <div class="emission-card negative">
                    <div class="emission-icon">üè≠</div>
                    <div class="emission-value">{{ "%.2f"|format(emissions.total_co2_landfill if emissions else 0) }} kg</div>
                    <div class="emission-label">CO‚ÇÇ from Landfill</div>
                </div>
                <div class="emission-card recycling">
                    <div class="emission-icon">‚ôªÔ∏è</div>
                    <div class="emission-value">{{ "%.2f"|format(emissions.total_waste_diverted if emissions else 0) }} kg</div>
                    <div class="emission-label">Waste Diverted</div>
                </div>
                <div class="emission-card net {% if emissions and emissions.net_co2_emissions < 0 %}net-positive{% else %}net-negative{% endif %}">
                    <div class="emission-icon">‚öñÔ∏è</div>
                    <div class="emission-value">{{ "%.2f"|format(emissions.net_co2_emissions if emissions else 0) }} kg</div>
                    <div class="emission-label">Net CO‚ÇÇ Impact</div>
                    <div class="emission-sublabel">
                        {% if emissions and emissions.net_co2_emissions < 0 %}
                            <span class="positive-impact">‚úì Carbon Negative</span>
                        {% else %}
                            <span class="negative-impact">‚ö† Carbon Positive</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <!-- Daily Weight Chart -->
        <section class="chart-section">
            <h2>üìà Daily Waste Collected (Last 7 Days)</h2>
            <div class="chart-container">
                <canvas id="capacityChart"></canvas>
            </div>
            <div class="chart-legend">
                <div class="legend-item">
                    <span class="legend-color normal"></span>
                    <span>Normal Waste</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color recycle"></span>
                    <span>Recyclable Waste</span>
                </div>
            </div>
        </section>

        <!-- Current Status Section -->
        <section class="status-section">
            <h2>Current Status</h2>
            <div class="status-grid">
                <!-- Normal Waste Bin -->
                <div class="bin-card normal-bin">
                    <div class="bin-header">
                        <h3>üóëÔ∏è Normal Waste</h3>
                    </div>
                    <div class="bin-content vertical-layout">
                        <div class="capacity-bar-vertical">
                            <div class="capacity-fill-vertical" style="height: {{ (status.normal_volume / status.normal_capacity * 100) if status else 0 }}%">
                                <span class="capacity-text-vertical">{{ "%.1f"|format((status.normal_volume / status.normal_capacity * 100) if status else 0) }}%</span>
                            </div>
                        </div>
                        <div class="bin-stats">
                            <div class="stat">
                                <span class="stat-label">Volume:</span>
                                <span class="stat-value">{{ "%.2f"|format(status.normal_volume if status else 0) }} L</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Weight:</span>
                                <span class="stat-value">{{ "%.2f"|format(status.normal_weight if status else 0) }} kg</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Capacity:</span>
                                <span class="stat-value">{{ "%.1f"|format((status.normal_volume / status.normal_capacity * 100) if status else 0) }}%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recyclable Waste Bin -->
                <div class="bin-card recycle-bin">
                    <div class="bin-header">
                        <h3>‚ôªÔ∏è Recyclable Waste</h3>
                    </div>
                    <div class="bin-content vertical-layout">
                        <div class="capacity-bar-vertical">
                            <div class="capacity-fill-vertical recycle" style="height: {{ (status.recycle_volume / status.recycle_capacity * 100) if status else 0 }}%">
                                <span class="capacity-text-vertical">{{ "%.1f"|format((status.recycle_volume / status.recycle_capacity * 100) if status else 0) }}%</span>
                            </div>
                        </div>
                        <div class="bin-stats">
                            <div class="stat">
                                <span class="stat-label">Volume:</span>
                                <span class="stat-value">{{ "%.2f"|format(status.recycle_volume if status else 0) }} L</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Weight:</span>
                                <span class="stat-value">{{ "%.2f"|format(status.recycle_weight if status else 0) }} kg</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Capacity:</span>
                                <span class="stat-value">{{ "%.1f"|format((status.recycle_volume / status.recycle_capacity * 100) if status else 0) }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% if status %}
            <p class="last-updated"><span class="label">Last Updated:</span> <span class="timestamp-cell">{{ status.last_updated }}</span></p>
            {% endif %}
        </section>

        <!-- Waste Statistics with Emissions -->
        <section class="stats-section">
            <h2 class="clickable-header" onclick="toggleSection('stats-content', 'stats-icon')">üìä Waste & Emissions Statistics <span id="stats-icon">‚ñº</span></h2>
            <div id="stats-content" style="display: none;">
            {% if stats %}
            <div class="stats-grid">
                {% for stat in stats %}
                <div class="stat-card {% if stat.waste_type == 'recycle' %}recycle{% else %}normal{% endif %}">
                    <h3>{% if stat.waste_type == 'recycle' %}‚ôªÔ∏è Recyclable{% else %}üóëÔ∏è Normal{% endif %} Waste</h3>
                    <div class="stat-details">
                        <div class="stat-row">
                            <span class="stat-label">Total Entries:</span>
                            <span class="stat-value">{{ stat.count }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Volume:</span>
                            <span class="stat-value">{{ "%.2f"|format(stat.total_volume) }} L</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Weight:</span>
                            <span class="stat-value">{{ "%.2f"|format(stat.total_weight) }} kg</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Volume:</span>
                            <span class="stat-value">{{ "%.2f"|format(stat.avg_volume) }} L</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Weight:</span>
                            <span class="stat-value">{{ "%.2f"|format(stat.avg_weight) }} kg</span>
                        </div>
                        <div class="stat-row emissions-row">
                            <span class="stat-label">Total CO‚ÇÇ:</span>
                            <span class="stat-value {% if stat.total_co2 < 0 %}positive-co2{% else %}negative-co2{% endif %}">
                                {{ "%.2f"|format(stat.total_co2 if stat.total_co2 else 0) }} kg
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="no-data">No statistics available yet.</p>
            {% endif %}
            </div>
        </section>

        <!-- Product Statistics Section -->
        <section class="product-stats-section">
            <h2 class="clickable-header" onclick="toggleSection('product-stats-content', 'product-stats-icon')">üì¶ Top 10 Products <span id="product-stats-icon">‚ñº</span></h2>
            <div id="product-stats-content" style="display: none;">
            {% if product_stats %}
            <div class="table-container">
                <table class="product-stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Product</th>
                            <th>Brand</th>
                            <th>Total Items</th>
                            <th>‚ôªÔ∏è Recyclable</th>
                            <th>üóëÔ∏è Normal</th>
                            <th>Weight (kg)</th>
                            <th>CO‚ÇÇ Impact (kg)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in product_stats %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td><strong>{{ product.product }}</strong></td>
                            <td>{{ product.brand if product.brand else '-' }}</td>
                            <td><span class="badge-total">{{ product.total_items }}</span></td>
                            <td><span class="badge-recycle">{{ product.recycle_count }}</span></td>
                            <td><span class="badge-normal">{{ product.normal_count }}</span></td>
                            <td>{{ "%.2f"|format(product.total_weight) }}</td>
                            <td class="{% if product.total_co2 < 0 %}positive-co2{% else %}negative-co2{% endif %}">
                                {{ "%.3f"|format(product.total_co2) }}
                                {% if product.total_co2 < 0 %}
                                    <span class="co2-indicator positive">‚Üì</span>
                                {% elif product.total_co2 > 0 %}
                                    <span class="co2-indicator negative">‚Üë</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="no-data">No product data available yet. Start adding items with product names!</p>
            {% endif %}
            </div>
        </section>

        <!-- Recent Logs Section -->
        <section class="logs-section">
            <h2 class="clickable-header" onclick="toggleSection('logs-content', 'logs-icon')">Recent Activity Logs <span id="logs-icon">‚ñº</span></h2>
            <div id="logs-content" style="display: none;">
            {% if logs %}
            <div class="logs-table-container">
                <table class="logs-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Event</th>
                            <th>Type</th>
                            <th>Brand</th>
                            <th>Product</th>
                            <th>Volume (L)</th>
                            <th>Weight (kg)</th>
                            <th>CO‚ÇÇ (kg)</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr class="{% if log.waste_type == 'recycle' %}recycle-row{% else %}normal-row{% endif %} {% if log.event_type|default('add') == 'empty' %}empty-event{% endif %}">
                            <td>{{ log.id }}</td>
                            <td>
                                <span class="event-badge {% if log.event_type|default('add') == 'empty' %}empty{% else %}add{% endif %}">
                                    {% if log.event_type|default('add') == 'empty' %}üßπ Empty{% else %}‚ûï Add{% endif %}
                                </span>
                            </td>
                            <td>
                                <span class="type-badge {% if log.waste_type == 'recycle' %}recycle{% else %}normal{% endif %}">
                                    {{ log.waste_type|capitalize }}
                                </span>
                            </td>
                            <td>{{ log.brand if log.brand else '-' }}</td>
                            <td>{{ log.product if log.product else '-' }}</td>
                            <td>{{ "%.2f"|format(log.volume) }}</td>
                            <td>{{ "%.2f"|format(log.weight) }}</td>
                            <td class="{% if log.co2_emissions|default(0) < 0 %}positive-co2{% elif log.co2_emissions|default(0) > 0 %}negative-co2{% endif %}">
                                {{ "%.3f"|format(log.co2_emissions|default(0)) }}
                                {% if log.co2_emissions|default(0) < 0 %}
                                    <span class="co2-indicator positive">‚Üì</span>
                                {% elif log.co2_emissions|default(0) > 0 %}
                                    <span class="co2-indicator negative">‚Üë</span>
                                {% endif %}
                            </td>
                            <td class="timestamp-cell">{{ log.timestamp }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="no-data">No activity logs yet.</p>
            {% endif %}
            </div>
        </section>

        <!-- API Testing Forms -->
        <section class="forms-section">
            <h2 class="clickable-header" onclick="toggleSection('forms-content', 'forms-icon')">API Testing Forms <span id="forms-icon">‚ñº</span></h2>
            <div id="forms-content" style="display: none;">
            <div class="forms-grid">
                <!-- Add Trash Form -->
                <div class="form-card">
                    <h3>üóëÔ∏è Add Trash Entry</h3>
                    <form id="addTrashForm">
                        <div class="form-group">
                            <label for="waste_type">Waste Type:</label>
                            <select id="waste_type" name="waste_type" required>
                                <option value="normal">Normal Waste</option>
                                <option value="recycle">Recyclable Waste</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="volume">Volume (L):</label>
                            <input type="number" id="volume" name="volume" step="0.1" min="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="weight">Weight (kg):</label>
                            <input type="number" id="weight" name="weight" step="0.1" min="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="brand">Brand (optional):</label>
                            <input type="text" id="brand" name="brand" placeholder="e.g., Coca-Cola, Pepsi">
                        </div>
                        <div class="form-group">
                            <label for="product">Product (optional):</label>
                            <input type="text" id="product" name="product" placeholder="e.g., Soda Can, Water Bottle">
                        </div>
                        <button type="submit" class="form-btn">Add Trash</button>
                    </form>
                </div>

                <!-- Empty Bin Form -->
                <div class="form-card">
                    <h3>üßπ Empty Trash Bin</h3>
                    <form id="emptyBinForm">
                        <div class="form-group">
                            <label for="empty_type">Bin to Empty:</label>
                            <select id="empty_type" name="waste_type" required>
                                <option value="normal">Normal Waste</option>
                                <option value="recycle">Recyclable Waste</option>
                                <option value="both">Both Bins</option>
                            </select>
                        </div>
                        <button type="submit" class="form-btn danger">Empty Bin</button>
                    </form>
                </div>

                <!-- Get Status Form -->
                <div class="form-card">
                    <h3>üìä Get Current Status</h3>
                    <form id="getStatusForm">
                        <p class="form-description">Fetch the latest bin status from the API</p>
                        <button type="submit" class="form-btn info">Get Status</button>
                    </form>
                </div>
            </div>

            <!-- Response Display -->
            <div id="apiResponse" class="api-response" style="display: none;">
                <h3>API Response:</h3>
                <pre id="responseContent"></pre>
            </div>
            </div>
        </section>

        <!-- API Documentation -->
        <section class="api-section">
            <h2 class="clickable-header" onclick="toggleSection('api-content', 'api-icon')">API Documentation <span id="api-icon">‚ñº</span></h2>
            <div id="api-content" style="display: none;">
            <div class="api-docs">
                <div class="api-endpoint">
                    <h3>Add Trash Entry</h3>
                    <code>POST /api/trash</code>
                    <pre>{
  "waste_type": "normal" or "recycle",
  "volume": 5.5,
  "weight": 2.3,
  "brand": "Coca-Cola" (optional)
}</pre>
                </div>
                <div class="api-endpoint">
                    <h3>Get Current Status</h3>
                    <code>GET /api/status</code>
                </div>
                <div class="api-endpoint">
                    <h3>Empty Bin</h3>
                    <code>POST /api/reset</code>
                    <pre>{
  "waste_type": "normal", "recycle", or "both"
}</pre>
                </div>
            </div>
            </div>
        </section>

        <footer>
            <p>Smart Trashbin Management System &copy; 2025</p>
            <button onclick="location.reload()" class="refresh-btn">üîÑ Refresh Dashboard</button>
        </footer>
    </div>

    <script>
        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }

        // Check for stored API response on page load
        window.addEventListener('DOMContentLoaded', function() {
            const storedResponse = sessionStorage.getItem('apiResponse');
            if (storedResponse) {
                const responseData = JSON.parse(storedResponse);
                showResponse(responseData.data, responseData.success);
                sessionStorage.removeItem('apiResponse');
            }
        });

        // Auto-refresh dashboard every 30 seconds (paused when camera feed is open)
        let autoRefresh = null;
        let isCameraFeedOpen = false;

        function startAutoRefresh() {
            if (!autoRefresh && !isCameraFeedOpen) {
                autoRefresh = setInterval(function() {
                    if (!isCameraFeedOpen) {
                        location.reload();
                    }
                }, 30000);
            }
        }

        function stopAutoRefresh() {
            if (autoRefresh) {
                clearInterval(autoRefresh);
                autoRefresh = null;
            }
        }

        // Start auto-refresh on page load
        startAutoRefresh();

        // Helper function to show API response
        function showResponse(data, success = true) {
            const responseDiv = document.getElementById('apiResponse');
            const responseContent = document.getElementById('responseContent');
            responseDiv.style.display = 'block';
            responseDiv.className = 'api-response ' + (success ? 'success' : 'error');
            responseContent.textContent = JSON.stringify(data, null, 2);
            
            // Scroll to response
            responseDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Helper function to store response and reload
        function storeAndReload(data, success) {
            sessionStorage.setItem('apiResponse', JSON.stringify({
                data: data,
                success: success
            }));
            location.reload();
        }

        // Add Trash Form Handler
        document.getElementById('addTrashForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                waste_type: document.getElementById('waste_type').value,
                volume: parseFloat(document.getElementById('volume').value),
                weight: parseFloat(document.getElementById('weight').value),
                brand: document.getElementById('brand').value,
                product: document.getElementById('product').value
            };

            try {
                const response = await fetch('/api/trash', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    this.reset();
                    storeAndReload(data, true);
                } else {
                    showResponse(data, false);
                }
            } catch (error) {
                showResponse({ error: error.message }, false);
            }
        });

        // Empty Bin Form Handler
        document.getElementById('emptyBinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const wasteType = document.getElementById('empty_type').value;
            
            if (!confirm(`Are you sure you want to empty the ${wasteType} bin(s)?`)) {
                return;
            }

            try {
                const response = await fetch('/api/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ waste_type: wasteType })
                });

                const data = await response.json();
                
                if (response.ok) {
                    storeAndReload(data, true);
                } else {
                    showResponse(data, false);
                }
            } catch (error) {
                showResponse({ error: error.message }, false);
            }
        });

        // Get Status Form Handler
        document.getElementById('getStatusForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const response = await fetch('/api/status', {
                    method: 'GET'
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResponse(data, true);
                } else {
                    showResponse(data, false);
                }
            } catch (error) {
                showResponse({ error: error.message }, false);
            }
        });

        // Daily Weight Chart with Real-time Updates
        const dailyCapacityData = {{ daily_capacity | tojson | safe }};
        
        // Extract data for chart
        const dates = dailyCapacityData.map(d => d.date);
        const normalData = dailyCapacityData.map(d => d.normal_weight);
        const recycleData = dailyCapacityData.map(d => d.recycle_weight);
        
        // Format dates for display
        const formattedDates = dates.map(date => {
            const d = new Date(date);
            const today = new Date();
            const isToday = d.toDateString() === today.toDateString();
            
            if (isToday) {
                return 'Today';
            } else {
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        });
        
        // Create chart
        const ctx = document.getElementById('capacityChart').getContext('2d');
        const capacityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: formattedDates,
                datasets: [
                    {
                        label: 'Normal Waste',
                        data: normalData,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#ff6b6b',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: 'Recyclable Waste',
                        data: recycleData,
                        borderColor: '#51cf66',
                        backgroundColor: 'rgba(81, 207, 102, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#51cf66',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' kg';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Weight Collected (kg)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + ' kg';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        // Toggle emissions info function
        function toggleEmissionsInfo() {
            const info = document.getElementById('emissions-info');
            const icon = document.getElementById('toggle-icon');
            if (info.style.display === 'none') {
                info.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                info.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        // Handle image upload and display
        let currentImageBase64 = null;
        let cameraFeedInterval = null;
        let lastImageTimestamp = null;

        // Poll for camera feed updates
        async function pollCameraFeed() {
            try {
                const response = await fetch('/api/camera-feed', {
                    method: 'GET'
                });

                const data = await response.json();
                
                if (data.success && data.timestamp !== lastImageTimestamp) {
                    // New image available
                    lastImageTimestamp = data.timestamp;
                    currentImageBase64 = data.image;
                    
                    const cameraImage = document.getElementById('cameraImage');
                    const placeholder = document.getElementById('cameraFeed');
                    
                    cameraImage.src = data.image;
                    cameraImage.style.display = 'block';
                    placeholder.style.display = 'none';
                }
            } catch (error) {
                console.error('Error polling camera feed:', error);
            }
        }

        // Start/stop camera feed polling when section is toggled
        function toggleCameraFeedPolling(isOpen) {
            isCameraFeedOpen = isOpen;
            
            if (isOpen) {
                // Stop auto-refresh when camera feed is open
                stopAutoRefresh();
                
                // Start polling every 2 seconds
                pollCameraFeed(); // Get initial image
                cameraFeedInterval = setInterval(pollCameraFeed, 100);
            } else {
                // Stop polling
                if (cameraFeedInterval) {
                    clearInterval(cameraFeedInterval);
                    cameraFeedInterval = null;
                }
                
                // Resume auto-refresh when camera feed is closed
                startAutoRefresh();
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                currentImageBase64 = e.target.result;
                
                // Send to API to broadcast to all users
                try {
                    const response = await fetch('/api/camera-feed', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            image: currentImageBase64
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert('Image uploaded and broadcast to all viewers!');
                    }
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Error uploading image: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }

        // Detect trash function (calls dummy API)
        async function detectTrash() {
            const resultDiv = document.getElementById('detectionResult');
            
            if (!currentImageBase64) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<p style="color: #c62828;">‚ö† Please upload an image first</p>';
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>üîÑ Detecting...</p>';
            
            try {
                const response = await fetch('/api/detect', {
                    method: 'GET',
                });

                const data = await response.json();

                const detections = data["out"];

                resultDiv.innerHTML = '';

                console.log(detections);

                detection = detections[0];

                console.log(detection);
                
                resultDiv.innerHTML = `
                    <p style="color: #2e7d32;">‚úì Detection Complete</p>
                    <p><strong>Recyclable:</strong>${detection["recyclable"]}</p>
                    <p><strong>Material:</strong>${detection["material"]}</p>
                    <p><strong>Item description:</strong>${detection["item_description"]}</p>
                    <p><strong>Brand name:</strong>${detection["brand_name"]}</p>
                    <p><strong>Weight (g):</strong>${detection["weight"]}</p>
                    <p><strong>Volume (mL):</strong>${detection["volume"]}</p>
                    `

                // for(detection in detections) {
                //     resultDiv.innerHTML += `
                //     <p style="color: #2e7d32;">‚úì Detection Complete</p>
                //     <p><strong>Recyclable:</strong>${detection["id"]}</p>
                //     <p><strong>Material:</strong>${detection["id"]}</p>
                //     <p><strong>Item description:</strong>${detection["item_description"]}</p>
                //     <p><strong>Brand name:</strong>${detection["brand_name"]}</p>
                //     <p><strong>Weight:</strong>${detection["weight"]}</p>
                //     `
                // }
                
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: #c62828;">‚ö† Error: ${error.message}</p>`;
            }
        }

        // Generic toggle section function
        function toggleSection(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
                
                // Start camera feed polling if this is the detect section
                if (contentId === 'detect-content') {
                    toggleCameraFeedPolling(true);
                }
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
                
                // Stop camera feed polling if this is the detect section
                if (contentId === 'detect-content') {
                    toggleCameraFeedPolling(false);
                }
            }
        }

        // Convert UTC timestamps to local time
        function convertTimestampsToLocal() {
            document.querySelectorAll('.timestamp-cell').forEach(cell => {
                const utcTime = cell.textContent.trim();
                if (utcTime && utcTime !== '-') {
                    try {
                        // Parse the timestamp (format: YYYY-MM-DD HH:MM:SS)
                        const date = new Date(utcTime.replace(' ', 'T') + 'Z'); // Add 'Z' to indicate UTC
                        
                        // Format as local time
                        const options = {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        };
                        const localTime = date.toLocaleString('en-CA', options).replace(',', '');
                        cell.textContent = localTime;
                    } catch (e) {
                        console.error('Error converting timestamp:', e);
                    }
                }
            });
        }

        // Convert timestamps on page load
        convertTimestampsToLocal();
    </script>
</body>
</html>
